<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pixel Art Editor</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    body { display: flex; height: 100vh; background-color: #2b2b2b; color: #fff; }
    #sidebar, #toolbar { padding: 10px; display: flex; flex-direction: column; background-color: #3a3a3a; }
    #canvasContainer { flex: 1; display: flex; justify-content: center; align-items: center; }
    #canvasWrapper { background-color: #fff; position: relative; overflow: hidden; cursor: crosshair; }
    #canvas { display: block; image-rendering: pixelated; }
    button { background-color: #4CAF50; color: white; border: none; padding: 10px; cursor: pointer; margin-top: 10px; }
    button:hover { background-color: #45a049; }
    .panel { background-color: #3a3a3a; padding: 10px; border-radius: 5px; margin-top: 10px; }
    #colorPicker, #gridSizeInput { width: 100%; margin-top: 5px; }
  </style>
</head>
<body>

<div id="sidebar">
  <h2>Ferramentas</h2>
  <div id="toolbar">
    <button onclick="setTool('pencil')">Lápis</button>
    <button onclick="setTool('eraser')">Borracha</button>
    <button onclick="setTool('bucket')">Balde de Tinta</button>
    <button onclick="setTool('colorPicker')">Seletor de Cor</button>
    <button onclick="undo()">Desfazer (Ctrl+Z)</button>
  </div>

  <div class="panel">
    <h3>Paleta</h3>
    <div id="paletteContainer"></div>
    <button onclick="savePalette()">Salvar Paleta</button>
    <input type="file" id="paletteInput" accept="image/*" onchange="loadPaletteFromImage(this)">
  </div>

  <div class="panel">
    <h3>Opções de Grade</h3>
    <label for="gridSizeInput">Tamanho da Grade:</label>
    <input type="number" id="gridSizeInput" value="16" min="1" max="512" onchange="setGridSize(this.value)">
  </div>
  
  <div class="panel">
    <h3>Configuração de Cor</h3>
    <input type="color" id="colorPicker" value="#000000" onchange="setColor(this.value)">
  </div>

  <button onclick="downloadImage()">Baixar Imagem</button>
</div>

<div id="canvasContainer">
  <div id="canvasWrapper">
    <canvas id="canvas"></canvas>
  </div>
</div>

<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let gridSize = 16;
  let tool = 'pencil';
  let color = '#000000';
  let palette = [];
  let pixelData = [];
  let history = [];

  function setTool(selectedTool) { tool = selectedTool; }
  function setColor(newColor) { color = newColor; }

  function initCanvas() {
    setGridSize(gridSize);
    loadRandomPalette();
  }

  function setGridSize(size) {
    gridSize = parseInt(size);
    canvas.width = gridSize * 16;
    canvas.height = gridSize * 16;
    pixelData = Array(gridSize).fill().map(() => Array(gridSize).fill('#ffffff'));
    drawGrid();
  }

  function drawGrid() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let x = 0; x < gridSize; x++) {
      for (let y = 0; y < gridSize; y++) {
        ctx.fillStyle = pixelData[x][y];
        ctx.fillRect(x * 16, y * 16, 16, 16);
        ctx.strokeRect(x * 16, y * 16, 16, 16);
      }
    }
  }

  function savePalette() {
    localStorage.setItem('palette', JSON.stringify(palette));
    alert('Paleta salva!');
  }

  function loadPaletteFromImage(input) {
    const reader = new FileReader();
    reader.onload = function(event) {
      const img = new Image();
      img.src = event.target.result;
      img.onload = function() {
        const imgCanvas = document.createElement('canvas');
        imgCanvas.width = img.width;
        imgCanvas.height = img.height;
        const imgCtx = imgCanvas.getContext('2d');
        imgCtx.drawImage(img, 0, 0);
        const data = imgCtx.getImageData(0, 0, img.width, img.height).data;
        palette = [];
        for (let i = 0; i < data.length; i += 4) {
          const color = `rgb(${data[i]}, ${data[i + 1]}, ${data[i + 2]})`;
          if (!palette.includes(color)) palette.push(color);
          if (palette.length >= 8) break;
        }
        renderPalette();
      };
    };
    reader.readAsDataURL(input.files[0]);
  }

  function renderPalette() {
    const paletteContainer = document.getElementById('paletteContainer');
    paletteContainer.innerHTML = '';
    palette.forEach((color, index) => {
      const colorDiv = document.createElement('div');
      colorDiv.style.backgroundColor = color;
      colorDiv.style.width = '20px';
      colorDiv.style.height = '20px';
      colorDiv.style.cursor = 'pointer';
      colorDiv.onclick = () => setColor(color);
      paletteContainer.appendChild(colorDiv);
    });
  }

  function loadRandomPalette() {
    palette = Array.from({ length: 8 }, () => `#${Math.floor(Math.random() * 16777215).toString(16)}`);
    renderPalette();
  }

  function undo() {
    if (history.length > 0) {
      pixelData = history.pop();
      drawGrid();
    }
  }

  function downloadImage() {
    const link = document.createElement('a');
    link.download = 'pixel_art.png';
    canvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.click();
      URL.revokeObjectURL(url);
    });
  }

  function handleCanvasClick(e) {
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / 16);
    const y = Math.floor((e.clientY - rect.top) / 16);

    if (tool === 'pencil') pixelData[x][y] = color;
    else if (tool === 'eraser') pixelData[x][y] = '#ffffff';
    else if (tool === 'bucket') fillArea(x, y, pixelData[x][y]);

    history.push(JSON.parse(JSON.stringify(pixelData)));
    drawGrid();
  }

  function fillArea(x, y, targetColor) {
    if (x < 0 || y < 0 || x >= gridSize || y >= gridSize || pixelData[x][y] !== targetColor) return;
    pixelData[x][y] = color;
    fillArea(x + 1, y, targetColor);
    fillArea(x - 1, y, targetColor);
    fillArea(x, y + 1, targetColor);
    fillArea(x, y - 1, targetColor);
  }

  canvas.addEventListener('mousedown', handleCanvasClick);
  document.addEventListener('keydown', (e) => { if (e.ctrlKey && e.key === 'z') undo(); });

  initCanvas();
</script>
</body>
</html>
